# ==============================================================================
# CONFIGURAÇÃO APACHE PARA LARAGON - Sistema de Campanhas EPS v4.0
# ==============================================================================
# Localização: /public/.htaccess
# Versão simplificada compatível com Laragon

# --- CONFIGURAÇÕES BÁSICAS ---
Options -Indexes -MultiViews
DirectoryIndex index.php login.php
AddDefaultCharset UTF-8

# --- ATIVA REWRITE ENGINE ---
RewriteEngine On

# --- PROTEÇÃO CONTRA ACESSO A ARQUIVOS SENSÍVEIS ---
<FilesMatch "^(\.env|\.htaccess|\.git|composer\.|package\.json|\.sql)">
    Require all denied
</FilesMatch>

# Bloqueia acesso aos diretórios do sistema
RewriteRule ^app/ - [F,L]
RewriteRule ^vendor/ - [F,L]
RewriteRule ^node_modules/ - [F,L]
RewriteRule ^\.git/ - [F,L]

# --- REDIRECIONAMENTOS PRINCIPAIS ---
# Redireciona raiz para login
RewriteRule ^/?$ /login.php [L,R=302]

# --- ROTAS DA API ---
# API de autenticação
RewriteRule ^api/auth/?$ api/auth_api.php [L,QSA]
RewriteRule ^api/login/?$ api/auth_api.php [L,QSA]

# API de cadastro
RewriteRule ^api/cadastro/?$ api/cadastro_api.php [L,QSA]
RewriteRule ^api/register/?$ api/cadastro_api.php [L,QSA]

# Validação em tempo real
RewriteRule ^api/cadastro/validate/?$ api/cadastro_api.php [L,QSA]

# --- CONFIGURAÇÕES DE CACHE ---
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Cache para assets estáticos
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    
    # Sem cache para páginas dinâmicas
    ExpiresByType text/html "access plus 0 seconds"
    ExpiresByType application/json "access plus 0 seconds"
</IfModule>

# --- COMPRESSÃO GZIP/DEFLATE ---
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# --- HEADERS DE SEGURANÇA ---
<IfModule mod_headers.c>
    # Remove headers que expõem informações
    Header unset Server
    Header unset X-Powered-By
    
    # Headers de segurança básicos
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Cache headers por tipo de arquivo
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=2592000"
        Header append Vary Accept-Encoding
    </FilesMatch>
    
    <FilesMatch "\.(png|jpg|jpeg|gif|webp|svg|ico|woff|woff2)$">
        Header set Cache-Control "public, max-age=31536000"
    </FilesMatch>
    
    # Sem cache para páginas dinâmicas
    <FilesMatch "\.(php|html)$">
        Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
        Header set Pragma "no-cache"
    </FilesMatch>
    
    # Headers para APIs
    <FilesMatch "api/.*\.php$">
        Header always set Content-Type "application/json; charset=utf-8"
        Header set Cache-Control "no-store, no-cache, must-revalidate"
    </FilesMatch>
</IfModule>

# --- PROTEÇÃO BÁSICA CONTRA ATAQUES ---
# Bloqueia user agents suspeitos
RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC]
RewriteRule .* - [F,L]

# Proteção contra directory traversal
RewriteCond %{QUERY_STRING} \.\.\/ [NC,OR]
RewriteCond %{QUERY_STRING} \.\.\\ [NC]
RewriteRule .* - [F,L]

# Proteção contra injection básica
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} union.*select.*\( [NC]
RewriteRule .* - [F,L]

# --- CONFIGURAÇÕES DE MIME TYPES ---
<IfModule mod_mime.c>
    AddType application/javascript .js
    AddType application/json .json
    AddType text/css .css
    AddType font/woff .woff
    AddType font/woff2 .woff2
    AddType image/svg+xml .svg
    AddType image/webp .webp
</IfModule>

# --- PÁGINAS DE ERRO CUSTOMIZADAS ---
ErrorDocument 400 /erro.php?code=400
ErrorDocument 401 /erro.php?code=401
ErrorDocument 403 /erro.php?code=403
ErrorDocument 404 /erro.php?code=404
ErrorDocument 500 /erro.php?code=500

# --- CONFIGURAÇÕES PHP (se mod_php estiver disponível) ---
<IfModule mod_php.c>
    php_value max_execution_time 30
    php_value memory_limit 256M
    php_value post_max_size 50M
    php_value upload_max_filesize 20M
    php_flag display_errors On
    php_flag log_errors On
</IfModule>